# PostGIS

### 11. Χωρικές Σχέσεις (Spatial Relationships)

Μέχρι τώρα, έχουμε χρησιμοποιήσει χωρικές συναρτήσεις που μετρούν χαρακτηριστικά (π.χ. `ST_Area`, `ST_Length`) ή μετατρέπουν μορφές (π.χ. `ST_GeomFromText`, `ST_AsGML`). Αυτές οι συναρτήσεις λειτουργούν συνήθως σε μία γεωμετρία κάθε φορά. Ωστόσο, η πραγματική δύναμη των χωρικών βάσεων δεδομένων έγκειται στην ικανότητά τους να **συγκρίνουν σχέσεις** μεταξύ γεωμετριών.

Για παράδειγμα, ερωτήματα όπως "Ποιοι είναι οι πλησιέστεροι χώροι στάθμευσης ποδηλάτων σε ένα πάρκο;" ή "Πού βρίσκονται οι διασταυρώσεις γραμμών μετρό και δρόμων;" απαιτούν σύγκριση σχέσεων. Το πρότυπο OGC (Open Geospatial Consortium) ορίζει ένα σύνολο μεθόδων για τη σύγκριση γεωμετριών.

**Βασικές αρχές:**
*   Οι χωρικές σχέσεις εξετάζουν πώς δύο γεωμετρίες αλληλεπιδρούν στο χώρο.
*   Οι περισσότερες συναρτήσεις επιστρέφουν `TRUE` ή `FALSE`.
*   Η κατανόηση της έννοιας του **εσωτερικού (interior)**, του **ορίου (boundary)** και του **εξωτερικού (exterior)** μιας γεωμετρίας είναι σημαντική για πολλές από αυτές τις συναρτήσεις.

### Σημαντικές Συναρτήσεις Χωρικών Σχέσεων και Παραδείγματα Χρήσης

Ακολουθούν οι πιο σημαντικές συναρτήσεις χωρικών σχέσεων με παραδείγματα:

#### 11.1. `ST_Equals(geometry A, geometry B)`
*   **Περιγραφή:** Ελέγχει την χωρική ισότητα δύο γεωμετριών. Επιστρέφει `TRUE` αν δύο γεωμετρίες του ίδιου τύπου έχουν πανομοιότυπες συντεταγμένες x,y, δηλαδή αν το δεύτερο σχήμα είναι ίσο (πανομοιότυπο) με το πρώτο σχήμα. Η κατεύθυνση (π.χ. μιας γραμμής) αγνοείται.
*   **Παράδειγμα (Έλεγχος ισότητας σημείων):**
    Ας ανακτήσουμε πρώτα την αναπαράσταση ενός σημείου (του Broad St) από τον πίνακα `nyc_subway_stations`.
    ```sql
    SELECT name, geom
    FROM nyc_subway_stations
    WHERE name = 'Broad St';
    ```
    (Αποτέλεσμα: `Broad St | 0101000020266900000EEBD4CF27CF2141BC17D69516315141`)

    Τώρα, χρησιμοποιούμε αυτή την αναπαράσταση για έναν έλεγχο `ST_Equals`:
    ```sql
    SELECT name
    FROM nyc_subway_stations
    WHERE ST_Equals(
        geom,
        '0101000020266900000EEBD4CF27CF2141BC17D69516315141'
    );
    ```
    (Αποτέλεσμα: `Broad St`)
    *Σημείωση:* Η χρήση της ακριβούς δυαδικής αναπαράστασης (WKB) είναι απαραίτητη για ελέγχους ισότητας.

#### 11.2. `ST_Intersects(geometry A, geometry B)`
*   **Περιγραφή:** Επιστρέφει `TRUE` αν τα δύο σχήματα έχουν οποιονδήποτε κοινό χώρο, δηλαδή αν τα όριά τους ή τα εσωτερικά τους τέμνονται. Είναι η πιο ευέλικτη και συχνά χρησιμοποιούμενη συνάρτηση.
*   **Παράδειγμα (Εύρεση γειτονιάς του Broad St):**
    ```sql
    SELECT name, boroname
    FROM nyc_neighborhoods
    WHERE ST_Intersects(geom, ST_GeomFromText('POINT(583571 4506714)',26918));
    ```
    (Αποτέλεσμα: `Financial District | Manhattan`)
    *Σημείωση:* Εδώ, η `ST_GeomFromText` χρησιμοποιείται για να δημιουργήσει ένα χωρικό αντικείμενο από μια αναπαράσταση κειμένου (WKT), συμπεριλαμβανομένου του SRID (26918).

#### 11.2. `ST_Disjoint(geometry A, geometry B)`
*   **Περιγραφή:** Το αντίθετο της `ST_Intersects`. Επιστρέφει `TRUE` αν οι δύο γεωμετρίες **δεν** τέμνονται χωρικά, δηλαδή αν δεν μοιράζονται κανένα χώρο.
*   **Σημαντική Σημείωση:** Συχνά είναι πιο αποδοτικό να ελέγχετε `NOT ST_Intersects(...)` παρά `ST_Disjoint(...)`, επειδή οι έλεγχοι `ST_Intersects` μπορούν να χρησιμοποιήσουν χωρικούς δείκτες (spatial indexes), ενώ οι έλεγχοι `ST_Disjoint` συνήθως όχι.

#### 11.2. `ST_Crosses(geometry A, geometry B)`
*   **Περιγραφή:** Επιστρέφει `TRUE` αν η τομή έχει διάσταση κατά ένα μικρότερη από τη μέγιστη διάσταση των δύο αρχικών γεωμετριών, και το σύνολο της τομής βρίσκεται εντός των εσωτερικών και των δύο αρχικών γεωμετριών. Συνήθως εφαρμόζεται σε:
    *   Σημείο/Πολυσημείο με Γραμμή/Πολυγώνου
    *   Γραμμή/Πολυγώνου με Γραμμή/Πολυγώνου

#### 11.2. `ST_Overlaps(geometry A, geometry B)`
*   **Περιγραφή:** Συγκρίνει δύο γεωμετρίες της ίδιας διάστασης και επιστρέφει `TRUE` αν το σύνολο της τομής τους είναι διαφορετικό και από τις δύο, αλλά έχει την ίδια διάσταση.
    *   Δεν πρέπει η μία να περιέχεται πλήρως στην άλλη.
    *   Εφαρμόζεται συνήθως σε Πολυσημείο με Πολυσημείο, Γραμμή με Γραμμή, Πολύγωνο με Πολύγωνο.

#### 11.3. `ST_Touches(geometry A, geometry B)`
*   **Περιγραφή:** Ελέγχει αν δύο γεωμετρίες αγγίζουν στα όριά τους, αλλά δεν τέμνονται στα εσωτερικά τους. Επιστρέφει `TRUE` αν τα όρια των γεωμετριών τέμνονται ή αν μόνο ένα από τα εσωτερικά των γεωμετριών τέμνει το όριο της άλλης.

#### 11.4. `ST_Within(geometry A, geometry B)`
*   **Περιγραφή:** Επιστρέφει `TRUE` αν η πρώτη γεωμετρία περιέχεται πλήρως στη δεύτερη γεωμετρία.

#### 11.4. `ST_Contains(geometry A, geometry B)`
*   **Περιγραφή:** Επιστρέφει `TRUE` αν η δεύτερη γεωμετρία περιέχεται πλήρως στην πρώτη γεωμετρία. Είναι το ακριβώς αντίθετο της `ST_Within`.

#### 11.5. `ST_Distance(geometry A, geometry B)`
*   **Περιγραφή:** Υπολογίζει την ελάχιστη 2-διάστατη καρτεσιανή απόσταση (με βάση το spatial reference) μεταξύ δύο γεωμετριών και την επιστρέφει ως δεκαδικό αριθμό (float). Χρησιμοποιείται για την αναφορά της πραγματικής απόστασης.
*   **Παράδειγμα:**
    ```sql
    SELECT ST_Distance(
        ST_GeomFromText('POINT(0 5)'),
        ST_GeomFromText('LINESTRING(-2 2, 2 2)')
    );
    ```
    (Αποτέλεσμα: `3`)

#### 11.5. `ST_DWithin(geometry A, geometry B, radius)`
*   **Περιγραφή:** Παρέχει έναν **ταχύτατο** και **index-accelerated** έλεγχο `TRUE`/`FALSE` για το αν δύο αντικείμενα βρίσκονται εντός μιας συγκεκριμένης απόστασης (`radius`) μεταξύ τους. Είναι εξαιρετικά χρήσιμο για ερωτήματα όπως "πόσα δέντρα βρίσκονται εντός 500 μέτρων από το δρόμο;" χωρίς να χρειάζεται να υπολογίσετε ένα buffer.
*   **Παράδειγμα (Εύρεση οδών σε απόσταση 10 μέτρων από το Broad St):**
    ```sql
    SELECT name
    FROM nyc_streets
    WHERE ST_DWithin(
        geom,
        ST_GeomFromText('POINT(583571 4506714)',26918),
        10
    );
    ```
    (Αποτέλεσμα:
    `Wall St`
    `Broad St`
    `Nassau St`)

### 12. & 14. Ασκήσεις Χωρικών Σχέσεων (Επιλεγμένα Παραδείγματα)

Οι ασκήσεις στο υλικό διδάσκουν την εφαρμογή των παραπάνω συναρτήσεων. Ενδεικτικά:

*   **Εύρεση γεωμετρίας:**
    ```sql
    SELECT ST_AsText(geom)
    FROM nyc_streets
    WHERE name = 'Atlantic Commons';
    ```
    (Αποτέλεσμα: `MULTILINESTRING((586781.701577724 4504202.15314339,586863.51964484 4504215.9881701))`)

*   **Εύρεση γειτονιάς στην οποία ανήκει ένας δρόμος (`ST_Intersects`):**
    ```sql
    SELECT name, boroname
    FROM nyc_neighborhoods
    WHERE ST_Intersects(
        geom,
        ST_GeomFromText('LINESTRING(586782 4504202,586864 4504216)', 26918)
    );
    ```
    (Αποτέλεσμα: `Fort Green | Brooklyn`)

*   **Υπολογισμός πληθυσμού σε απόσταση (`ST_DWithin` με `SUM`):**
    ```sql
    SELECT Sum(popn_total)
    FROM nyc_census_blocks
    WHERE ST_DWithin(
        geom,
        ST_GeomFromText('LINESTRING(586782 4504202,586864 4504216)', 26918),
        50
    );
    ```
    (Αποτέλεσμα: `1438`)

### 13. Χωρικές Συνδέσεις (Spatial Joins)

Οι χωρικές συνδέσεις είναι η "ραχοκοκαλιά" των χωρικών βάσεων δεδομένων. Σας επιτρέπουν να **συνδυάσετε πληροφορίες από διαφορετικούς πίνακες** χρησιμοποιώντας χωρικές σχέσεις ως κλειδί σύνδεσης (join key).

**Βασικές αρχές:**
*   Αντί για ένα συμβατικό `JOIN ON column1 = column2`, χρησιμοποιούμε `JOIN ON ST_SpatialFunction(geom1, geom2)`.
*   Επιτρέπουν την απάντηση σύνθετων ερωτημάτων σε ένα μόνο βήμα.
*   Οι πιο συχνά χρησιμοποιούμενες συναρτήσεις για χωρικές συνδέσεις είναι οι `ST_Intersects`, `ST_Contains` και `ST_DWithin`.

#### Παράδειγμα (Σταθμός μετρό σε γειτονιά - απλή χωρική σύνδεση):
*   Ερώτημα: "Σε ποια γειτονιά βρίσκεται ο σταθμός 'Broad St' και σε ποιο δήμο;"
    ```sql
    SELECT
        subways.name AS subway_name,
        neighborhoods.name AS neighborhood_name,
        neighborhoods.boroname AS borough
    FROM nyc_neighborhoods AS neighborhoods
    JOIN nyc_subway_stations AS subways
    ON ST_Contains(neighborhoods.geom, subways.geom)
    WHERE subways.name = 'Broad St';
    ```
    (Αποτέλεσμα: `Broad St | Financial District | Manhattan`)

#### 13.1. Συνδέσεις και Σύνοψη (Join and Summarize)

Ο συνδυασμός `JOIN` με `GROUP BY` παρέχει το είδος της ανάλυσης που γίνεται συνήθως σε ένα σύστημα GIS.

*   **Παράδειγμα (Πληθυσμός και φυλετική σύνθεση γειτονιών στο Manhattan):**
    ```sql
    SELECT
        neighborhoods.name AS neighborhood_name,
        Sum(census.popn_total) AS population,
        100.0 * Sum(census.popn_white) / Sum(census.popn_total) AS white_pct,
        100.0 * Sum(census.popn_black) / Sum(census.popn_total) AS black_pct
    FROM nyc_neighborhoods AS neighborhoods
    JOIN nyc_census_blocks AS census
    ON ST_Intersects(neighborhoods.geom, census.geom)
    WHERE neighborhoods.boroname = 'Manhattan'
    GROUP BY neighborhoods.name
    ORDER BY white_pct DESC;
    ```
    (Επιστρέφει μία λίστα γειτονιών του Manhattan με τον πληθυσμό και τα ποσοστά λευκών/μαύρων κατοίκων, ταξινομημένα κατά ποσοστό λευκών).
    *   **Διαδικασία:** Ο `JOIN` δημιουργεί έναν εικονικό πίνακα. Το `WHERE` φιλτράρει τις γραμμές. Το `GROUP BY` ομαδοποιεί και το `SUM` αθροίζει τους πληθυσμούς.

#### 13.2. Προηγμένες Συνδέσεις (Advanced Join)

Μπορείτε να χρησιμοποιήσετε πολλαπλές συνδέσεις και συνθήκες για πιο σύνθετες αναλύσεις.

*   **Παράδειγμα (Φυλετική σύνθεση γύρω από κάθε γραμμή μετρό):**
    1.  **Δημιουργία πίνακα με γραμμές μετρό:**
        ```sql
        CREATE TABLE subway_lines ( route char(1));
        INSERT INTO subway_lines (route) VALUES
        ('A'), ('B'),('C'),('D'), ('E'), ('F'),('G'),
        ('J'),('L'), ('M'),('N'), ('Q'), ('R'),('S'),
        ('Z'),('1'),('2'),('3'),('4'),('5'),('6'),
        ('7');
        ```
    2.  **Σύνδεση τριών πινάκων:**
        ```sql
        SELECT
            lines.route,
            100.0 * Sum(popn_white) / Sum(popn_total) AS white_pct,
            100.0 * Sum(popn_black) / Sum(popn_total) AS black_pct,
            Sum(popn_total) AS popn_total
        FROM nyc_census_blocks AS census
        JOIN nyc_subway_stations AS subways
        ON ST_DWithin(census.geom, subways.geom, 200) -- Συναρτήσεις χωρικής σχέσης ως ON condition
        JOIN subway_lines AS lines
        ON strpos(subways.routes, lines.route) > 0 -- Ελέγχει αν η γραμμή περιέχεται στις διαδρομές του σταθμού
        GROUP BY lines.route
        ORDER BY black_pct DESC;
        ```
        (Αποτέλεσμα: Λίστα με τις γραμμές του μετρό, ποσοστά λευκών/μαύρων και συνολικό πληθυσμό σε απόσταση 200 μέτρων, ταξινομημένα κατά ποσοστό μαύρων.)

### Πίνακες Δεδομένων που Χρησιμοποιούνται στα Παραδείγματα:

Για να κατανοήσετε καλύτερα τα παραδείγματα, να έχετε υπόψη τους παρακάτω πίνακες και τα σημαντικά τους πεδία:
*   `nyc_census_blocks`: `blkid`, `popn_total`, `boroname`, `geom` (πολύγωνο)
*   `nyc_streets`: `name`, `type`, `geom` (γραμμή)
*   `nyc_subway_stations`: `name`, `routes` (κείμενο), `geom` (σημείο)
*   `nyc_neighborhoods`: `name`, `boroname`, `geom` (πολύγωνο)
*   `subway_lines`: `route` (χαρ/ρας) - πίνακας που δημιουργήθηκε για τις ασκήσεις.

### Σημαντικά Σημεία και Συμβουλές Μελέτης:

1.  **Κατανόηση του SRID:** Πάντα να προσέχετε το Spatial Reference ID (SRID) των γεωμετριών σας. Το 26918 (NAD83 / New York Long Island) χρησιμοποιείται στα παραδείγματα.
2.  **Χρήση Δεικτών (Indexing):** Για βέλτιστη απόδοση σε μεγάλες βάσεις δεδομένων, βεβαιωθείτε ότι έχετε δημιουργήσει χωρικούς δείκτες (π.χ. GiST indexes) στα πεδία γεωμετρίας σας. Η `ST_DWithin` εκμεταλλεύεται τους δείκτες για γρήγορους ελέγχους εγγύτητας.
3.  **Εκτέλεση Ερωτημάτων:** Εξασκηθείτε στην εκτέλεση αυτών των ερωτημάτων στον δικό σας περιβάλλον PostGIS. Ο πειραματισμός είναι ο καλύτερος τρόπος εκμάθησης.
4.  **Σχέση `ST_Intersects` και `ST_Disjoint`:** Θυμηθείτε ότι `ST_Disjoint(A, B)` είναι ισοδύναμο με `NOT ST_Intersects(A, B)`. Συχνά η δεύτερη μορφή είναι πιο αποδοτική λόγω των δυνατοτήτων index-acceleration.
